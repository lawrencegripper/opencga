{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "vmSize": {
      "type": "string",
      "metadata": {
        "description": "Size of vm (e.g. Standard_D1_v2)"
      },
      "defaultValue": "Standard_D1_v2"
    },
    "dnsLabelPrefix": {
      "type": "string",
      "defaultValue": "cgamongo",
      "metadata": {
        "description": "Unique DNS Name for the Public IP used to access the Virtual Machine."
      }
    },
    "certificateEmail": {
      "type": "string",
      "metadata": {
        "description": "Email address used for mongoDB letsencrypt certificates"
      }
    },
    "clusterSize": {
      "type": "int",
      "defaultValue": 3,
      "allowedValues": [
        1,
        3,
        5,
        7,
        9,
        11
      ],
      "metadata": {
        "description": "Amount of VMs to deploy for the mongodb replica set"
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "The username for all mongoDB VMs (also used for connecting oer SSH)"
      }
    },
    "adminSSHKeyData": {
      "type": "string",
      "metadata": {
        "description": "The mongoDB VM public SSH key"
      }
    },
    "mongoDBUsername": {
      "type": "string",
      "defaultValue": "opencga",
      "metadata": {
        "description": "The username for connecting to mongoDB"
      }
    },
    "mongoDBPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for connecting to mongoDB"
      }
    },
    "subnetId": {
      "type": "string",
      "metadata": {
        "description": "Subnet ID"
      }
    }
  },
  "variables": {
    "vmName": "mongo-vm",
    "nicName": "mongo-nic",
    "publicIPAddressName": "mongo-publicip",
    "publicIPAddressType": "Static",
    "dnsPrefix": "[concat(parameters('dnsLabelPrefix'), uniquestring(resourceGroup().id))]",
    "sshKeyPath": "[concat('/home/',parameters('adminUsername'),'/.ssh/authorized_keys')]",
    "copy": [
      {
        "name": "dnsNames",
        "count": "[parameters('clusterSize')]",
        "input": {
          "fqdn": "[concat(variables('dnsPrefix'),copyIndex('dnsNames'),'.',parameters('location'),'.cloudapp.azure.com')]"
        }
      }
    ]
  },
  "resources": [
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[concat(variables('nicName'), copyIndex())]",
      "location": "[parameters('location')]",
      "copy": {
        "name": "mongo-ip",
        "count": "[parameters('clusterSize')]"
      },
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'), copyIndex())]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('publicIPAddressName'), copyIndex()))]"
              },
              "subnet": {
                "id": "[parameters('subnetId')]"
              }
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[concat(variables('publicIPAddressName'), copyIndex())]",
      "location": "[parameters('location')]",
      "copy": {
        "name": "mongo-ip",
        "count": "[parameters('clusterSize')]"
      },
      "properties": {
        "publicIPAllocationMethod": "[variables('publicIPAddressType')]",
        "dnsSettings": {
          "domainNameLabel": "[concat(variables('dnsPrefix'), copyIndex())]"
        }
      }
    },
    {
      "name": "[concat(variables('vmName'), copyIndex())]",
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2018-06-01",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'), copyIndex())]"
      ],
      "copy": {
        "name": "mongo-rs",
        "count": "[parameters('clusterSize')]"
      },
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('vmSize')]"
        },
        "storageProfile": {
          "osDisk": {
            "osType": "Linux",
            "createOption": "FromImage",
            "managedDisk": {
              "storageAccountType": "Standard_LRS"
            }
          },
          "imageReference": {
            "publisher": "Canonical",
            "offer": "UbuntuServer",
            "sku": "16.04-LTS",
            "version": "latest"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('nicName'), copyIndex()))]"
            }
          ]
        },
        "osProfile": {
          "computerName": "[concat(variables('vmName'), copyIndex())]",
          "customData": "#cloud-config\n\nwrite_files:\n -  encoding: gzip\n    content: !!binary |\n        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\n    path: /opt/installmongodb.sh\n    permissions: \"0744\"\n -  encoding: gzip\n    content: !!binary |\n        [local-gzipBase64File('renew_mongo_cert.sh')]\n    path: /opt/renew_mongo_cert.sh\n    permissions: \"0744\"\n\n",
          "linuxConfiguration": {
            "disablePasswordAuthentication": true,
            "ssh": {
              "publicKeys": [
                {
                  "path": "[variables('sshKeyPath')]",
                  "keyData": "[parameters('adminSSHKeyData')]"
                }
              ]
            }
          },
          "adminUsername": "[parameters('adminUsername')]",
          "allowExtensionOperations": true
        }
      },
      "tags": {}
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('vmName'), copyIndex(), '/configureagent')]",
      "apiVersion": "2017-12-01",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'), copyIndex())]"
      ],
      "copy": {
        "name": "mongo-rs-ca",
        "count": "[parameters('clusterSize')]"
      },
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.0",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "timestamp": 4
        },
        "protectedSettings": {
          "commandToExecute": "[concat(' VM_INDEX=', copyIndex(), ' CLUSTER_SIZE=', parameters('clusterSize'), ' CERT_EMAIL=', parameters('certificateEmail'),' MONGODB_USERNAME=', parameters('mongoDBUsername'),' MONGODB_PASSWORD=', parameters('mongoDBPassword'),' APP_DNS_NAME=', reference(resourceId('Microsoft.Network/publicIPAddresses',concat(variables('publicIPAddressName'),copyIndex())),'2017-10-01').dnsSettings.fqdn, ' /bin/bash /opt/installmongodb.sh')]"
        }
      }
    }
  ],
  "outputs": {
    "mongoDBUser": {
      "value": "[parameters('mongoDBUsername')]",
      "type": "string"
    },
    "mongoDBPassword": {
      "value": "[parameters('mongoDBPassword')]",
      "type": "string"
    },
    "mongoClusterSize": {
      "value": "[parameters('clusterSize')]",
      "type": "int"
    },
    "dnsNames": {
      "value": "[variables('dnsNames')]",
      "type": "array"
    }
  }
}